dist: xenial

language: python

compiler: g++

python:
  - 3.6

env:
  global:
    - TRAVIS_CI=true
    - PYTHONPATH=$(pwd)
    - COVERAGE_PROCESS_START="$(pwd)/tox.ini"

cache:
  directories:
    - $HOME/.cache/pip

install:
  - pip install pipenv codecov


jobs:
  include:
    - stage: "Tests"
      name: "Lint"
      script:
        - pipenv lock --dev --requirements > dev-reqs.txt
        - pip install -r dev-reqs.txt
        - make lint
    - name: "pipenv check"
      script:
        - pipenv check || (sleep 60; pipenv check) || (sleep 60; pipenv check)
    - name: "Unit Tests"
      before_script:
        - ulimit -c unlimited -S       # enable core dumps
      script:
        - pipenv lock --requirements > reqs.txt
        - pip install -r reqs.txt
        - sudo apt-get install -y gdb  # install gdb
        - make testcert.cert
        - coverage erase
        - ./test.py -s
        - ls -la
        - coverage combine
      after_success:
        - codecov
      after_failure:
        - PYTHON_EXECUTABLE=$(python3 -c "import sys; print(sys.executable)")
        - COREFILE=$(find . -maxdepth 1 -name "core*" | head -n 1) # find core file
        - if [[ -f "$COREFILE" ]]; then
              gdb -c "$COREFILE" $PYTHON_EXECUTABLE -ex "thread apply all bt" -ex "set pagination 0" -batch;
          fi
